# README


## 系统重启如何恢复

### AccountManagerActor (AMA）的恢复


#### 状态数据
AMA内存数据主要有两种，1）每个地址各个Token的balance,allowance和锁定的情况，2）改地址对应的一些pending订单。

#### 恢复

我们这里首先假设一个AMA管理一个单一地址的上述数据。那么当这个actor重启之后，就可以给某个SystemRecoverActor （SRA）发一个消息，说“我重启了，你读一下数据库，按时间顺序，按批次告诉我这个地址的所有依然有效的订单”。SRA就会读取数据库，把订单依次发给这个AMA。**这个AMA处理每个订单的逻辑，和新订单的方式完全一样（在第一个有效订单来的时候，还要问一下数据库这个地址相关的一两个token的余额和allowance情况）；并且如果订单在AMA中提交成功，也会同样提交给对应的MMA。**

如果这个地址的订单比较多，恢复的时间可能十几秒甚至几分钟。在这个过程中，如果以太坊那边有新的事件过来（比如该地址的余额有变化，或者某个订单状态或者成交量有变化），这些事件也会被该AMA处理。照成恢复后的数据和重启前不是完全一致的。不过我觉得这不是问题。

#### 问题

- 如果一个AMA对应一个address，那么如果很AMA死亡，那么这些AMA就会几乎同时请求SRA恢复数据，造成雪崩效应。所以应该在AMA上面在加一个管理Actor，这个Actor一方面负责动态部署其管理的AMA，另一方面可以再大规模重启的时候，总体协调恢复的过程。一个简单的方法是将所有地址空间做个sharding，每个shard一台服务器，对应于一个AccountManagerShardingActor（AMSA）
，恢复按照shard来恢复，而不是按照地址来恢复。


### MarketManagerActor（MMA）的恢复

#### 状态数据
AMA内存数据主要是一个市场所有活跃的订单。

#### 恢复
一个MMA对应于一个市场，如果该Actor重启，只需要告诉SystemRecoverActor （SRA）发一个消息，说“我需要你把这个市场所有有效订单全部按照时间顺序，依次提交给对应的AMA或AMSA，并且在处理完所有的数据后通知我一声”。

#### 问题

- 如果一些AMA和一些MMA都重启了，系统如何协调恢复数据？其实不管是AMA还是MMA恢复，只是订单的选择条件不一样，订单数据流向都是完全一样的，因此有可能将几个恢复工作的订单选择进行合并。比如说shard1刚刚请求恢复，shard2也来请求，market1也来请求，这时候这些请求可以变成

```
select * from orders
where shard in (shard1, shard2) or market in (market1, market 2)
```

我们可以把上面的工作代理给一个 SystemRecoverJobActor，由SystemRecoverActor管理。并且做个映射，上述4个工作统一由这个job actor负责。如果过了N秒的一个时间限制，另一个job也来了，就启动另一个独立的job actor，否则如果在N秒内，就做等待。继续合并job。



### OrderbookManagerActor（OMA）的恢复

如果OrderbookManager死亡，就主动问它负责的MMA，来恢复数据即可。


### 上述恢复方式的优点

- 我们不再需要把以太坊的“事件”数据解析出来了放到MySQL里面，只需要在恢复的过程中去查询账号和订单状态数据即可。

- AMA，MMA，OMA都无需保留状态，系统重启后只需要按照时间顺序恢复有效订单；这个数据流和提交新订单完全一样，并且还可以过滤掉过期的订单；



### 上述恢复方式的缺点
由于在恢复过程中可以接收并处理新订单和以太坊上的事件，因此恢复后状态不是强一致的。不过由于这几个actor的状态数据在建立的时候也不是强一致的，因此没有关系。



